<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>rast-web</title>
</head>
<body>
    <div>Render Time: <span id="renderTime">0</span></div>
    <canvas id="canvas" width="800" height="600"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const renderTimeElement = document.getElementById('renderTime');
        const ctx = canvas.getContext('2d');

        let frameRequests = 0;
        let frameResponses = 0;
        let lastFrameTime = Date.now();
        let frameCount = 0;
        let fps = 0;
        let isRunning = true;
        let intervalId = null;

        function updateFrame() {
            if (!isRunning) return;
            
            const pendingRequests = frameRequests - frameResponses;
            if (pendingRequests < 3) {
                frameRequests++;

                fetch('/pixels')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.arrayBuffer();
                    })
                    .then(buffer => {
                        frameResponses++;
                        
                        if (buffer.byteLength !== canvas.width * canvas.height * 4) {
                            throw new Error(`Expected ${canvas.width * canvas.height * 4} bytes, got ${buffer.byteLength}`);
                        }
                        
                        const imageData = ctx.createImageData(canvas.width, canvas.height);
                        imageData.data.set(new Uint8Array(buffer));
                        ctx.putImageData(imageData, 0, 0);
                        
                        updateFpsDisplay();
                    })
                    .catch(err => {
                        frameResponses++;
                    });

                fetch('/time')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(timeText => {
                        const renderTime = parseFloat(timeText);
                        renderTimeElement.textContent = renderTime.toFixed(4);
                    })
                    .catch(err => {
                        console.error('Failed to fetch render time:', err);
                    });
            }
        }

        function startRenderer() {
            if (intervalId) clearInterval(intervalId);
            isRunning = true;
            intervalId = setInterval(updateFrame, 1000/60);
        }

        startRenderer();
    </script>
</body>
</html>
